<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartHelp â€“ Painel TÃ©cnico</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
<header>
  ðŸ“‹ SmartHelp â€“ Painel TÃ©cnico
  <button id="btnLogout" style="float:right; margin-top:-5px;">Sair</button>
</header>

<div class="container">
  <h2>Tickets Recebidos</h2>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Categoria</th>
        <th>Prioridade</th>
        <th>Estado</th>
        <th>AÃ§Ã£o</th>
      </tr>
    </thead>
    <tbody id="ticketList"></tbody>
  </table>
</div>

<script type="module">
  import { firebaseConfig } from "./firebase.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getFirestore, collection, getDocs,
    doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ðŸ”§ Firebase
  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  const tbody     = document.getElementById("ticketList");
  const btnLogout = document.getElementById("btnLogout");

  // ðŸ” Proteger painel: sÃ³ entra se estiver autenticado
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      // nÃ£o autenticado â†’ volta ao login
      window.location.href = "login.html";
    } else {
      carregarTickets();
    }
  });

  // ðŸšª Logout
  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  // ðŸ“¥ Carregar tickets
  async function carregarTickets() {
    tbody.innerHTML = "<tr><td colspan='6'>A carregar...</td></tr>";

    const snap = await getDocs(collection(db, "tickets"));
    tbody.innerHTML = "";

    snap.forEach(d => {
      const t = d.data();
      const idDoc = d.id;

      const estadoClasse =
        t.estado === "Aberto" ? "aberto" :
        t.estado === "Em andamento" ? "andamento" :
        "resolvido";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.id || "(sem ID)"}</td>
        <td>${t.nome}</td>
        <td>${t.categoria}</td>
        <td>${t.prioridade}</td>
        <td>
          <span class="estado ${estadoClasse}">${t.estado}</span>
        </td>
        <td>
          <select class="estadoSelect" data-doc="${idDoc}">
            <option value="Aberto" ${t.estado === "Aberto" ? "selected" : ""}>Aberto</option>
            <option value="Em andamento" ${t.estado === "Em andamento" ? "selected" : ""}>Em andamento</option>
            <option value="Fechado" ${t.estado === "Fechado" || t.estado === "Resolvido" ? "selected" : ""}>Fechado</option>
          </select>
          <button class="btnSalvar" data-doc="${idDoc}">Guardar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Ligar eventos aos botÃµes "Guardar"
    document.querySelectorAll(".btnSalvar").forEach(btn => {
      btn.addEventListener("click", async () => {
        const idDoc = btn.getAttribute("data-doc");
        const select = document.querySelector(`.estadoSelect[data-doc="${idDoc}"]`);
        const novoEstado = select.value;

        await updateDoc(doc(db, "tickets", idDoc), { estado: novoEstado });

        alert("Estado do ticket atualizado para: " + novoEstado);
        carregarTickets(); // refrescar tabela
      });
    });
  }
</script>

</body>
</html>
